<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRP Proxy 配置查看器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .server-info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .server-config-form {
            margin-top: 15px;
        }

        .server-config-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .server-config-row label {
            color: white;
            font-weight: 500;
            font-size: 1.1em;
        }

        .server-config-row input,
        .server-config-row select {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 1em;
        }

        .server-config-row input:focus,
        .server-config-row select:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
        }

        #serverAddrInput {
            width: 150px;
        }

        #serverPortInput {
            width: 95px;
        }

        #authMethodSelect {
            width: 125px;
        }

        #tokenInput {
            width: 140px;
        }

        .test-connectivity-btn {
            padding: 8px 16px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-right: 8px;
        }

        .test-connectivity-btn:hover {
            background: #138496;
        }

        .test-connectivity-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .connect-frps-btn {
            padding: 8px 16px;
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-right: 8px;
        }

        .connect-frps-btn:hover {
            background: #e68500;
        }

        .connect-frps-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .save-config-btn {
            padding: 8px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-left: auto;
        }

        .save-config-btn:hover {
            background: #218838;
        }

        .save-config-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .server-config-row span {
            color: white;
            font-size: 1.1em;
            font-weight: 500;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .refresh-btn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .add-btn {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
        }

        .add-btn:hover {
            background: #218838;
        }

        .view-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 25px;
            padding: 3px;
        }

        .view-btn {
            padding: 8px 20px;
            border: none;
            background: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .proxy-count {
            margin-bottom: 0;
            font-size: 1.1em;
            color: #666;
        }

        /* 状态信息区域 */
        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .frpc-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            color: #666;
        }

        .frpc-status .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #6c757d;
        }

        .frpc-status .status-dot.running {
            background: #28a745;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        .frpc-status .status-dot.stopped {
            background: #dc3545;
        }

        .frpc-action-btn {
            margin-left: 10px;
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            color: white;
        }

        .frpc-action-btn.start {
            background: #28a745;
        }

        .frpc-action-btn.start:hover {
            background: #218838;
        }

        .frpc-action-btn.stop {
            background: #dc3545;
        }

        .frpc-action-btn.stop:hover {
            background: #c82333;
        }

        /* 列表视图样式 */
        .list-view {
            display: block;
        }

        .list-view .proxy-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .proxy-item:hover {
            cursor: pointer;
        }

        .proxy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .proxy-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .proxy-type {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .proxy-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-label {
            font-weight: 500;
            color: #666;
            min-width: 80px;
        }

        .detail-value {
            color: #333;
            font-family: monospace;
            background: #e9ecef;
            padding: 6px 18px;
            border-radius: 4px;
            font-size: 2.1em;
            font-weight: 600;
        }

        /* 卡片视图样式 */
        .card-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .card-view .proxy-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .card-view .proxy-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-view .proxy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-view .proxy-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-view .proxy-details {
            grid-template-columns: 1fr;
        }

        .hidden {
            display: none !important;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-data h3 {
            margin-bottom: 10px;
            color: #999;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-right: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .public-ip {
            font-size: 0.9em;
            opacity: 0.8;
            font-weight: normal;
            margin-left: 15px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .test-btn {
            padding: 8px 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-left: 10px;
            min-width: 80px;
        }

        .test-btn:hover {
            background: #138496;
        }

        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .test-result {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .duplicate-warning {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .remote-port-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .remote-port-input {
            flex: 1;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #17a2b8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 自定义弹框样式 */
        .custom-alert {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .custom-alert-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border: none;
            border-radius: 10px;
            width: fit-content;
            min-width: 300px;
            max-width: min(600px, 85vw);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .custom-alert-header {
            padding: 15px 20px 10px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .custom-alert-icon {
            font-size: 20px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
        }

        .custom-alert-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .custom-alert-icon.error {
            background: #f8d7da;
            color: #721c24;
        }

        .custom-alert-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .custom-alert-icon.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .custom-alert-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        .custom-alert-body {
            padding: 12px 20px 20px 20px;
        }

        .custom-alert-message {
            color: #666;
            line-height: 1.4;
            margin: 0;
            font-size: 14px;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-width: 400px;
        }

        .custom-alert-footer {
            padding: 12px 20px 16px 20px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .custom-alert-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .custom-alert-btn.primary {
            background: #667eea;
            color: white;
        }

        .custom-alert-btn.primary:hover {
            background: #5a6fd8;
        }

        .custom-alert-btn.danger {
            background: #dc3545;
            color: white;
        }

        .custom-alert-btn.danger:hover {
            background: #c82333;
        }

        .custom-alert-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .custom-alert-btn.secondary:hover {
            background: #5a6268;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 日志面板样式 */
        .log-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .log-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .log-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .log-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .refresh-log-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .refresh-log-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .stop-frpc-btn {
            background: #dc3545;
            color: white;
        }

        .stop-frpc-btn:hover {
            background: #c82333;
        }

        .close-log-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
        }

        .close-log-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .log-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .status-dot.running {
            background: #28a745;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        .status-dot.stopped {
            background: #dc3545;
        }

        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.3; }
        }

        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .log-entry.error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            padding: 6px;
            border-radius: 4px;
            border-bottom: 1px solid #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FRP Proxy 配置查看器</h1>
            <p>自动读取 frpc.toml 文件中的代理配置</p>
            <div class="server-info" id="serverInfo" style="display: none;">
                <div class="server-config-form">
                    <div class="server-config-row">
                        <label>服务器:</label>
                        <input type="text" id="serverAddrInput" placeholder="如: 118.195.137.151" />
                        <label>端口:</label>
                        <input type="number" id="serverPortInput" placeholder="36915" min="1" max="65535" />
                        <label>认证方式:</label>
                        <select id="authMethodSelect">
                            <option value="none">无认证</option>
                            <option value="token">Token认证</option>
                        </select>
                        <input type="text" id="tokenInput" placeholder="认证token" style="display: none;" />
                        <button class="test-connectivity-btn" onclick="testServerConnectivity()">测试连通性</button>
                        <button class="connect-frps-btn" onclick="connectToFrps()">连接至frps</button>
                        <button class="save-config-btn" onclick="saveServerConfig()">保存配置</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-left">
                <div class="file-info">
                    <div class="status-dot"></div>
                    <span id="fileInfo">正在加载配置文件...</span>
                </div>
                <button class="refresh-btn" onclick="loadProxies()">刷新</button>
                <button class="add-btn" onclick="showAddModal()">+ 添加代理</button>
            </div>

            <div class="view-toggle">
                <button class="view-btn" onclick="switchView('list')">列表视图</button>
                <button class="view-btn active" onclick="switchView('card')">卡片视图</button>
            </div>
        </div>

        <div class="content">
            <div class="status-info">
                <div class="proxy-count" id="proxyCount"></div>
                <div class="frpc-status" id="frpcStatus">
                    <span class="status-dot" id="frpcStatusDot"></span>
                    <span id="frpcStatusText">正在检查frpc状态...</span>
                    <button class="frpc-action-btn" id="frpcActionBtn" onclick="toggleFrpcProcess()" style="display: none;">操作</button>
                </div>
            </div>
            <div id="proxyContainer">
                <div class="loading">
                    <h3>正在加载...</h3>
                    <p>正在读取代理配置文件</p>
                </div>
            </div>
        </div>

        <!-- FRP日志面板 -->
        <div id="logPanel" class="log-panel" style="display: none;">
            <div class="log-header">
                <h3>FRP 连接日志</h3>
                <div class="log-controls">
                    <button class="log-btn refresh-log-btn" onclick="refreshLogs()">刷新日志</button>
                    <button class="log-btn stop-frpc-btn" onclick="stopFrpc()">停止连接</button>
                    <button class="log-btn close-log-btn" onclick="closeLogPanel()">&times;</button>
                </div>
            </div>
            <div class="log-content">
                <div class="log-status" id="logStatus">
                    <span class="status-dot running" id="statusDot"></span>
                    <span id="statusText">正在连接...</span>
                </div>
                <div class="log-output" id="logOutput"></div>
            </div>
        </div>
    </div>

    <!-- 添加代理模态框 -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>添加新代理 <span class="public-ip" id="publicIP">正在获取公网IP...</span></h2>
                <span class="close" onclick="hideAddModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addProxyForm">
                    <div class="form-group">
                        <label for="proxyName">代理名称 *</label>
                        <input type="text" id="proxyName" name="name" required placeholder="例如: WR-50-MySQL">
                    </div>

                    <div class="form-group">
                        <label for="proxyType">协议类型 *</label>
                        <select id="proxyType" name="type" required>
                            <option value="">选择协议类型</option>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                            <option value="http">HTTP</option>
                            <option value="https">HTTPS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="localIP">本地IP *</label>
                        <input type="text" id="localIP" name="localIP" required placeholder="例如: 192.168.11.50" value="127.0.0.1">
                    </div>

                    <div class="form-group">
                        <label for="localPort">本地端口 *</label>
                        <div class="remote-port-group">
                            <div class="remote-port-input">
                                <input type="number" id="localPort" name="localPort" required placeholder="例如: 3306" min="1" max="65535" onblur="checkDuplicates()">
                            </div>
                            <button type="button" class="test-btn" onclick="checkLocalDuplicate()" id="checkLocalBtn" style="background: #6c757d;">检测重复</button>
                        </div>
                        <div id="localPortWarning"></div>
                    </div>

                    <div class="form-group">
                        <label for="remotePort">远程端口 *</label>
                        <div class="remote-port-group">
                            <div class="remote-port-input">
                                <input type="number" id="remotePort" name="remotePort" required placeholder="例如: 19966" min="1" max="65535" onblur="checkDuplicates()">
                            </div>
                            <button type="button" class="test-btn" onclick="testConnectivity()" id="testBtn">检测</button>
                        </div>
                        <div id="testResult"></div>
                        <div id="remotePortWarning"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAddModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="addProxy()">添加</button>
            </div>
        </div>
    </div>

    <!-- 修改代理模态框 -->

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>修改代理配置</h2>
                <span class="close" onclick="hideEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProxyForm">
                    <div class="form-group">
                        <label for="editProxyName">代理名称 *</label>
                        <input type="text" id="editProxyName" name="name" required placeholder="例如: WR-50-MySQL">
                    </div>

                    <div class="form-group">
                        <label for="editProxyType">协议类型 *</label>
                        <select id="editProxyType" name="type" required>
                            <option value="">选择协议类型</option>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                            <option value="http">HTTP</option>
                            <option value="https">HTTPS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editLocalIP">本地IP *</label>
                        <input type="text" id="editLocalIP" name="localIP" required placeholder="例如: 192.168.11.50">
                    </div>

                    <div class="form-group">
                        <label for="editLocalPort">本地端口 *</label>
                        <input type="number" id="editLocalPort" name="localPort" required placeholder="例如: 3306" min="1" max="65535">
                    </div>

                    <div class="form-group">
                        <label for="editRemotePort">远程端口 *</label>
                        <input type="number" id="editRemotePort" name="remotePort" required placeholder="例如: 19966" min="1" max="65535">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideEditModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateProxy()">保存修改</button>
                <button type="button" class="btn" style="background: #dc3545; color: white;" onclick="deleteProxy()">删除代理</button>
            </div>
        </div>
    </div>

    <!-- 自定义弹框 -->
    <div id="customAlert" class="custom-alert">
        <div class="custom-alert-content">
            <div class="custom-alert-header">
                <div class="custom-alert-icon" id="alertIcon">!</div>
                <h3 class="custom-alert-title" id="alertTitle">提示</h3>
            </div>
            <div class="custom-alert-body">
                <p class="custom-alert-message" id="alertMessage">消息内容</p>
            </div>
            <div class="custom-alert-footer" id="alertFooter">
                <button class="custom-alert-btn primary" onclick="hideCustomAlert()">确定</button>
            </div>
        </div>
    </div>

    <script>
        let currentView = 'card';
        let proxies = [];
        let currentEditIndex = -1;

        async function loadProxies() {
            try {
                const response = await fetch('/api/proxies');
                const result = await response.json();

                if (result.success) {
                    proxies = result.data.proxies || [];
                    updateFileInfo(result.filePath, result.lastModified);
                    updateServerInfo(result.data.serverInfo);
                    renderProxies();
                    updateProxyCount();
                    // 检查frpc系统状态
                    checkFrpcSystemStatus();
                } else {
                    showError(result.error);
                }
            } catch (error) {
                console.error('获取代理配置时出错:', error);
                showError('无法连接到服务器，请确保服务器正在运行');
            }
        }

        function showError(message) {
            const container = document.getElementById('proxyContainer');
            container.innerHTML = `
                <div class="error">
                    <h3>错误</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function updateServerInfo(serverInfo) {
            if (serverInfo && (serverInfo.serverAddr || serverInfo.serverPort)) {
                document.getElementById('serverAddrInput').value = serverInfo.serverAddr || '';
                document.getElementById('serverPortInput').value = serverInfo.serverPort || '';

                // 更新认证方式
                const authMethod = serverInfo.method || (serverInfo.token ? 'token' : 'none');
                document.getElementById('authMethodSelect').value = authMethod;

                if (authMethod === 'token') {
                    document.getElementById('tokenInput').style.display = 'inline-block';
                    document.getElementById('tokenInput').value = ''; // 不显示实际token
                } else {
                    document.getElementById('tokenInput').style.display = 'none';
                    document.getElementById('tokenInput').value = '';
                }

                document.getElementById('serverInfo').style.display = 'block';

                // 添加认证方式切换事件监听
                document.getElementById('authMethodSelect').addEventListener('change', function() {
                    const method = this.value;
                    const tokenInput = document.getElementById('tokenInput');
                    if (method === 'token') {
                        tokenInput.style.display = 'inline-block';
                        tokenInput.required = true;
                    } else {
                        tokenInput.style.display = 'none';
                        tokenInput.required = false;
                        tokenInput.value = '';
                    }
                });
            } else {
                document.getElementById('serverInfo').style.display = 'none';
            }
        }

        function updateFileInfo(filePath, lastModified) {
            const fileInfo = document.getElementById('fileInfo');
            const date = new Date(lastModified);
            fileInfo.innerHTML = `
                文件: ${filePath}<br>
                最后修改: ${date.toLocaleString()}
            `;
        }

        function renderProxies() {
            const container = document.getElementById('proxyContainer');

            if (proxies.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>未找到代理配置</h3>
                        <p>该文件中没有找到 [[proxies]] 配置</p>
                    </div>
                `;
                return;
            }

            const viewClass = currentView === 'list' ? 'list-view' : 'card-view';
            container.innerHTML = `<div class="${viewClass}" id="proxiesList"></div>`;

            const proxiesList = document.getElementById('proxiesList');
            proxiesList.innerHTML = proxies.map((proxy, index) => `
                <div class="proxy-item" onclick="showEditModal(${index})">
                    <div class="proxy-header">
                        <div class="proxy-name">
                            <span class="status-indicator"></span>
                            ${proxy.name || 'Unnamed Proxy'}
                            <div class="proxy-type">${proxy.type || 'Unknown'}</div>
                        </div>
                    </div>
                    <div class="proxy-details">
                        ${proxy.localIP ? `
                            <div class="detail-item">
                                <span class="detail-label">本地IP:</span>
                                <span class="detail-value">${proxy.localIP}</span>
                            </div>
                        ` : ''}
                        ${proxy.localPort ? `
                            <div class="detail-item">
                                <span class="detail-label">本地端口:</span>
                                <span class="detail-value">${proxy.localPort}</span>
                            </div>
                        ` : ''}
                        ${proxy.remotePort ? `
                            <div class="detail-item">
                                <span class="detail-label">远程端口:</span>
                                <span class="detail-value">${proxy.remotePort}</span>
                            </div>
                        ` : ''}
                        ${proxy.customDomains ? `
                            <div class="detail-item">
                                <span class="detail-label">自定义域名:</span>
                                <span class="detail-value">${proxy.customDomains}</span>
                            </div>
                        ` : ''}
                        ${proxy.subdomain ? `
                            <div class="detail-item">
                                <span class="detail-label">子域名:</span>
                                <span class="detail-value">${proxy.subdomain}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateProxyCount() {
            const countElement = document.getElementById('proxyCount');
            countElement.textContent = `共找到 ${proxies.length} 个代理配置`;
        }

        // 检查系统中的frpc进程状态
        async function checkFrpcSystemStatus() {
            try {
                const response = await fetch('/api/frpc-system-status');
                const result = await response.json();

                if (result.success) {
                    updateFrpcStatus(result.isRunning, result.processCount, result.message);
                } else {
                    updateFrpcStatus(false, 0, '检查状态失败');
                }
            } catch (error) {
                console.error('检查frpc系统状态失败:', error);
                updateFrpcStatus(false, 0, '无法连接服务器');
            }
        }

        // 更新frpc状态显示
        function updateFrpcStatus(isRunning, processCount, message) {
            const statusDot = document.getElementById('frpcStatusDot');
            const statusText = document.getElementById('frpcStatusText');
            const actionBtn = document.getElementById('frpcActionBtn');

            if (isRunning) {
                statusDot.className = 'status-dot running';
                statusText.textContent = `frpc客户端: 运行中 (${processCount}个进程)`;
                statusText.style.color = '#28a745';

                // 显示停止按钮
                actionBtn.style.display = 'inline-block';
                actionBtn.textContent = '停止';
                actionBtn.className = 'frpc-action-btn stop';
            } else {
                statusDot.className = 'status-dot stopped';
                statusText.textContent = 'frpc客户端: 未运行';
                statusText.style.color = '#dc3545';

                // 显示启动按钮
                actionBtn.style.display = 'inline-block';
                actionBtn.textContent = '启动';
                actionBtn.className = 'frpc-action-btn start';
            }
        }

        // 切换frpc进程状态
        async function toggleFrpcProcess() {
            const actionBtn = document.getElementById('frpcActionBtn');

            // 检查当前状态
            const isStartAction = actionBtn.classList.contains('start');

            try {
                if (isStartAction) {
                    // 启动frpc - 直接调用connectToFrps功能
                    connectToFrps();
                } else {
                    // 停止frpc
                    const originalText = actionBtn.textContent;
                    actionBtn.disabled = true;
                    actionBtn.textContent = '停止中...';

                    const response = await fetch('/api/stop-frpc', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        await showCustomAlert('frpc已停止', 'success', '停止成功');
                    } else {
                        await showCustomAlert('frpc停止失败: ' + result.error, 'error', '停止失败');
                    }

                    // 立即检查状态
                    setTimeout(checkFrpcSystemStatus, 1000);

                    actionBtn.disabled = false;
                    actionBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('切换frpc状态失败:', error);
                await showCustomAlert('操作失败，请检查网络连接', 'error', '网络错误');
            }
        }

        function switchView(view) {
            currentView = view;

            // 更新按钮状态
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 重新渲染
            renderProxies();
        }

        // 页面加载时自动读取文件
        window.addEventListener('load', function() {
            loadProxies();

            // 启动5秒间隔的frpc状态检查
            setInterval(checkFrpcSystemStatus, 5000);
        });

        // 模态框功能
        function showAddModal() {
            document.getElementById('addModal').style.display = 'block';
            // 获取公网IP
            loadPublicIP();
        }

        // 获取公网IP
        async function loadPublicIP() {
            const publicIPElement = document.getElementById('publicIP');
            publicIPElement.textContent = '正在获取公网IP...';

            try {
                const response = await fetch('/api/public-ip');
                const result = await response.json();

                if (result.success && result.ip !== '未知') {
                    publicIPElement.textContent = `(本机公网IP: ${result.ip})`;
                } else {
                    publicIPElement.textContent = '(无法获取公网IP)';
                }
            } catch (error) {
                console.error('获取公网IP时出错:', error);
                publicIPElement.textContent = '(无法获取公网IP)';
            }
        }

        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addProxyForm').reset();
            // 清除测试结果和警告
            document.getElementById('testResult').innerHTML = '';
            document.getElementById('localPortWarning').innerHTML = '';
            document.getElementById('remotePortWarning').innerHTML = '';
        }

        // 检测本地IP+端口重复
        function checkLocalDuplicate() {
            const localIP = document.getElementById('localIP').value.trim();
            const localPort = document.getElementById('localPort').value.trim();
            const localPortWarning = document.getElementById('localPortWarning');
            const checkLocalBtn = document.getElementById('checkLocalBtn');

            // 检查必填字段
            if (!localIP || !localPort) {
                localPortWarning.innerHTML = `
                    <div class="test-result error">
                        请先填写本地IP和端口
                    </div>
                `;
                return;
            }

            // 显示检测状态
            checkLocalBtn.disabled = true;
            checkLocalBtn.innerHTML = '<span class="spinner"></span>检测中...';

            // 清除之前的警告
            localPortWarning.innerHTML = '';

            // 检查本地IP+端口组合是否重复
            const localDuplicate = proxies.find(proxy =>
                proxy.localIP === localIP && proxy.localPort == localPort
            );

            setTimeout(() => {
                if (localDuplicate) {
                    localPortWarning.innerHTML = `
                        <div class="test-result error">
                            ⚠️ 本地地址重复！已存在代理 "${localDuplicate.name}" 使用相同的 ${localIP}:${localPort}
                        </div>
                    `;
                } else {
                    localPortWarning.innerHTML = `
                        <div class="test-result success">
                            ✓ 本地地址可用！${localIP}:${localPort} 未被占用
                        </div>
                    `;
                }

                // 恢复按钮状态
                checkLocalBtn.disabled = false;
                checkLocalBtn.innerHTML = '检测重复';
            }, 500); // 模拟检测过程
        }

        // 检查重复配置
        function checkDuplicates() {
            const localIP = document.getElementById('localIP').value.trim();
            const localPort = document.getElementById('localPort').value.trim();
            const remotePort = document.getElementById('remotePort').value.trim();

            const localPortWarning = document.getElementById('localPortWarning');
            const remotePortWarning = document.getElementById('remotePortWarning');

            // 清除之前的警告
            localPortWarning.innerHTML = '';
            remotePortWarning.innerHTML = '';

            if (!localIP || !localPort || !remotePort) {
                return; // 如果有字段为空，不进行检查
            }

            // 检查本地IP+端口组合是否重复
            const localDuplicate = proxies.find(proxy =>
                proxy.localIP === localIP && proxy.localPort === localPort
            );

            if (localDuplicate) {
                localPortWarning.innerHTML = `
                    <div class="duplicate-warning">
                        ⚠️ 本地地址重复！已存在代理 "${localDuplicate.name}" 使用相同的 ${localIP}:${localPort}
                    </div>
                `;
            }

            // 检查远程端口是否重复
            const remoteDuplicate = proxies.find(proxy =>
                proxy.remotePort === remotePort
            );

            if (remoteDuplicate) {
                remotePortWarning.innerHTML = `
                    <div class="duplicate-warning">
                        ⚠️ 远程端口重复！已存在代理 "${remoteDuplicate.name}" 使用相同的远程端口 ${remotePort}
                    </div>
                `;
            }
        }

        // 测试连接性
        async function testConnectivity() {
            const testBtn = document.getElementById('testBtn');
            const testResult = document.getElementById('testResult');

            // 检查是否有远程端口
            const remotePort = document.getElementById('remotePort').value;
            if (!remotePort) {
                testResult.innerHTML = '<div class="test-result error">请先输入远程端口</div>';
                return;
            }

            // 显示加载状态
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="spinner"></span>检测中...';
            testResult.innerHTML = '';

            try {
                const response = await fetch('/api/test-connectivity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ remotePort: parseInt(remotePort) })
                });

                const result = await response.json();

                if (result.success && result.connectivity) {
                    const connectivity = result.connectivity;
                    let resultClass = 'success';
                    let message = '';

                    if (connectivity.ping && connectivity.telnet) {
                        message = '✓ 连接正常 - Ping和端口都通畅';
                        resultClass = 'success';
                    } else if (connectivity.ping && !connectivity.telnet) {
                        message = '⚠️ 部分连通 - 服务器可达但端口不通';
                        resultClass = 'warning';
                    } else if (!connectivity.ping && connectivity.telnet) {
                        message = '⚠️ 部分连通 - Ping不通但端口可达';
                        resultClass = 'warning';
                    } else {
                        message = '✗ 连接失败 - 服务器和端口都不通';
                        resultClass = 'error';
                    }

                    testResult.innerHTML = `
                        <div class="test-result ${resultClass}">
                            ${message}<br>
                            <small>Ping: ${connectivity.ping ? '✓' : '✗'} | Telnet: ${connectivity.telnet ? '✓' : '✗'}</small>
                        </div>
                    `;
                } else {
                    testResult.innerHTML = '<div class="test-result error">检测失败: ' + (result.error || '未知错误') + '</div>';
                }
            } catch (error) {
                console.error('检测连接性时出错:', error);
                testResult.innerHTML = '<div class="test-result error">检测失败: 网络错误</div>';
            } finally {
                // 恢复按钮状态
                testBtn.disabled = false;
                testBtn.innerHTML = '检测';
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            const serverEditModal = document.getElementById('serverEditModal');

            if (event.target === addModal) {
                hideAddModal();
            } else if (event.target === editModal) {
                hideEditModal();
            } else if (event.target === serverEditModal) {
                hideServerEditModal();
            }
        }

        // 添加代理
        async function addProxy() {
            const form = document.getElementById('addProxyForm');
            const formData = new FormData(form);

            // 验证表单
            if (!form.checkValidity()) {
                await showCustomAlert('请填写所有必填字段', 'warning', '表单验证');
                return;
            }

            // 再次检查重复
            const localIP = formData.get('localIP').trim();
            const localPort = parseInt(formData.get('localPort'));
            const remotePort = parseInt(formData.get('remotePort'));

            // 检查本地IP+端口组合是否重复
            const localDuplicate = proxies.find(proxy =>
                proxy.localIP === localIP && proxy.localPort == localPort
            );

            if (localDuplicate) {
                await showCustomAlert(`⚠️ 本地地址重复！已存在代理 "${localDuplicate.name}" 使用相同的 ${localIP}:${localPort}`, 'warning', '地址重复');
                return;
            }

            // 检查远程端口是否重复
            const remoteDuplicate = proxies.find(proxy =>
                proxy.remotePort == remotePort
            );

            if (remoteDuplicate) {
                await showCustomAlert(`⚠️ 远程端口重复！已存在代理 "${remoteDuplicate.name}" 使用相同的远程端口 ${remotePort}`, 'warning', '端口重复');
                return;
            }

            // 显示加载状态
            const addButton = document.querySelector('.btn-primary');
            const originalText = addButton.textContent;
            addButton.textContent = '添加中...';
            addButton.disabled = true;

            const proxyData = {
                name: formData.get('name'),
                type: formData.get('type'),
                localIP: localIP,
                localPort: localPort,
                remotePort: remotePort
            };

            try {
                const response = await fetch('/api/proxies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(proxyData)
                });

                const result = await response.json();

                if (result.success) {
                    await showCustomAlert('代理添加成功！', 'success', '成功');
                    hideAddModal();
                    loadProxies(); // 重新加载数据
                } else {
                    await showCustomAlert('添加失败: ' + result.error, 'error', '错误');
                }
            } catch (error) {
                console.error('添加代理时出错:', error);
                await showCustomAlert('添加失败，请检查网络连接', 'error', '网络错误');
            } finally {
                // 恢复按钮状态
                addButton.textContent = originalText;
                addButton.disabled = false;
            }
        }

        // 显示编辑模态框
        function showEditModal(index) {
            currentEditIndex = index;
            const proxy = proxies[index];

            // 填充表单数据
            document.getElementById('editProxyName').value = proxy.name || '';
            document.getElementById('editProxyType').value = proxy.type || '';
            document.getElementById('editLocalIP').value = proxy.localIP || '';
            document.getElementById('editLocalPort').value = proxy.localPort || '';
            document.getElementById('editRemotePort').value = proxy.remotePort || '';

            // 显示模态框
            document.getElementById('editModal').style.display = 'block';
        }

        // 隐藏编辑模态框
        function hideEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editProxyForm').reset();
            currentEditIndex = -1;
        }

        // 更新代理（暂时只是提示功能）
        async function updateProxy() {
            const form = document.getElementById('editProxyForm');
            const formData = new FormData(form);

            if (!form.checkValidity()) {
                await showCustomAlert('请填写所有必填字段', 'warning', '表单验证');
                return;
            }

            // 获取表单数据
            const updatedProxy = {
                name: formData.get('name'),
                type: formData.get('type'),
                localIP: formData.get('localIP'),
                localPort: parseInt(formData.get('localPort')),
                remotePort: parseInt(formData.get('remotePort'))
            };

            console.log('更新代理:', updatedProxy);
            await showCustomAlert('修改功能开发中，当前仅显示编辑界面', 'info', '功能提示');
            hideEditModal();
        }

        // 自定义弹框系统
        function showCustomAlert(message, type = 'info', title = '提示', showConfirm = false) {
            const alertModal = document.getElementById('customAlert');
            const alertIcon = document.getElementById('alertIcon');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            const alertFooter = document.getElementById('alertFooter');

            // 设置图标和样式
            alertIcon.className = 'custom-alert-icon';
            alertModal.className = 'custom-alert';

            switch (type) {
                case 'success':
                    alertIcon.textContent = '✓';
                    alertModal.classList.add('success');
                    break;
                case 'error':
                    alertIcon.textContent = '✗';
                    alertModal.classList.add('error');
                    break;
                case 'warning':
                    alertIcon.textContent = '⚠';
                    alertModal.classList.add('warning');
                    break;
                case 'info':
                default:
                    alertIcon.textContent = 'i';
                    alertModal.classList.add('info');
                    break;
            }

            alertTitle.textContent = title;
            alertMessage.textContent = message;

            // 设置按钮
            if (showConfirm) {
                alertFooter.innerHTML = `
                    <button class="custom-alert-btn secondary" onclick="hideCustomAlert(false)">取消</button>
                    <button class="custom-alert-btn primary" onclick="hideCustomAlert(true)">确定</button>
                `;
            } else {
                alertFooter.innerHTML = `
                    <button class="custom-alert-btn primary" onclick="hideCustomAlert(true)">确定</button>
                `;
            }

            alertModal.style.display = 'flex';
            return new Promise(resolve => {
                window.alertResolve = resolve;
            });
        }

        function hideCustomAlert(result = true) {
            const alertModal = document.getElementById('customAlert');
            alertModal.style.display = 'none';
            if (window.alertResolve) {
                window.alertResolve(result);
                window.alertResolve = null;
            }
        }

        function showConfirm(message, title = '确认') {
            return showCustomAlert(message, 'warning', title, true);
        }

        // 删除代理功能
        async function deleteProxy() {
            if (currentEditIndex === -1) return;

            const proxy = proxies[currentEditIndex];

            try {
                const response = await fetch(`/api/proxies/${currentEditIndex}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    await showCustomAlert('代理删除成功！', 'success', '成功');
                    hideEditModal();
                    loadProxies(); // 重新加载数据
                } else {
                    await showCustomAlert('删除失败: ' + result.error, 'error', '错误');
                }
            } catch (error) {
                console.error('删除代理时出错:', error);
                await showCustomAlert('删除失败，请重试', 'error', '删除失败');
            }
        }

        // 服务器配置编辑功能

        // 测试服务器连通性
        async function testServerConnectivity() {
            // 获取用户输入的服务器信息
            const serverAddr = document.getElementById('serverAddrInput').value.trim();
            const serverPort = parseInt(document.getElementById('serverPortInput').value);

            // 验证必填字段
            if (!serverAddr || !serverPort) {
                await showCustomAlert('请填写服务器地址和端口后再进行测试', 'warning', '测试提醒');
                return;
            }

            const testBtn = document.querySelector('.test-connectivity-btn');
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';

            try {
                // 调用连通性测试API
                const testResponse = await fetch('/api/test-connectivity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        serverAddr: serverAddr,
                        remotePort: serverPort
                    })
                });

                const testResult = await testResponse.json();

                if (testResponse.ok && testResult.success) {
                    const { connectivity } = testResult;

                    // 显示测试结果
                    let message = `服务器连通性测试结果：\n`;
                    message += `- 服务器: ${serverAddr}:${serverPort}\n`;
                    message += `- Ping测试: ${connectivity.ping ? '✓ 成功' : '✗ 失败'}\n`;
                    message += `- 端口连通性: ${connectivity.telnet ? '✓ 成功' : '✗ 失败'}`;

                    const alertType = (connectivity.ping || connectivity.telnet) ? 'success' : 'error';
                    const title = (connectivity.ping || connectivity.telnet) ? '连通性测试成功' : '连通性测试失败';

                    await showCustomAlert(message, alertType, title);
                } else {
                    await showCustomAlert('测试失败: ' + (testResult.error || '未知错误'), 'error', '测试失败');
                }
            } catch (error) {
                console.error('连通性测试出错:', error);
                await showCustomAlert('测试出错，请检查网络连接', 'error', '测试异常');
            } finally {
                // 恢复按钮状态
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // 连接到frps服务器
        async function connectToFrps() {
            const connectBtn = document.querySelector('.connect-frps-btn');
            const originalText = connectBtn.textContent;
            connectBtn.disabled = true;
            connectBtn.textContent = '启动中...';

            try {
                const response = await fetch('/api/connect-frps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // 显示日志面板
                    showLogPanel();

                    // 启动日志轮询
                    startLogPolling();

                    connectBtn.textContent = '已启动';
                    connectBtn.style.background = '#28a745';
                } else {
                    await showCustomAlert('启动失败: ' + (result.error || '未知错误'), 'error', '启动失败');
                    connectBtn.disabled = false;
                    connectBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('连接frps时出错:', error);
                await showCustomAlert('连接失败，请检查网络连接', 'error', '连接异常');
                connectBtn.disabled = false;
                connectBtn.textContent = originalText;
            }
        }

        async function saveServerConfig() {
            // 从内联输入框获取数据
            const serverAddr = document.getElementById('serverAddrInput').value.trim();
            const serverPort = parseInt(document.getElementById('serverPortInput').value);
            const authMethod = document.getElementById('authMethodSelect').value;
            const token = document.getElementById('tokenInput').value.trim();

            const serverConfig = {
                serverAddr,
                serverPort,
                authMethod,
                token
            };

            // 验证必填字段
            if (!serverConfig.serverAddr || !serverConfig.serverPort) {
                await showCustomAlert('请填写服务器地址和端口', 'warning', '表单验证');
                return;
            }

            if (serverConfig.authMethod === 'token' && !serverConfig.token) {
                await showCustomAlert('选择Token认证时必须填写Token', 'warning', '表单验证');
                return;
            }

            const saveBtn = document.querySelector('.save-config-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            try {
                const response = await fetch('/api/server-config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(serverConfig)
                });

                const result = await response.json();

                if (result.success) {
                    await showCustomAlert('服务器配置更新成功！', 'success', '保存成功');
                    loadProxies(); // 重新加载数据
                } else {
                    await showCustomAlert('保存失败: ' + result.error, 'error', '保存失败');
                }
            } catch (error) {
                console.error('更新服务器配置时出错:', error);
                await showCustomAlert('保存失败，请检查网络连接', 'error', '网络错误');
            } finally {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // 日志面板相关功能
        let logPollingInterval = null;

        function showLogPanel() {
            document.getElementById('logPanel').style.display = 'block';
            updateLogStatus(true);
        }

        function closeLogPanel() {
            document.getElementById('logPanel').style.display = 'none';
            stopLogPolling();

            // 恢复连接按钮状态
            const connectBtn = document.querySelector('.connect-frps-btn');
            connectBtn.disabled = false;
            connectBtn.textContent = '连接至frps';
            connectBtn.style.background = '';
        }

        function updateLogStatus(isRunning) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (isRunning) {
                statusDot.className = 'status-dot running';
                statusText.textContent = 'FRP客户端正在运行中...';
            } else {
                statusDot.className = 'status-dot stopped';
                statusText.textContent = 'FRP客户端已停止';
            }
        }

        function startLogPolling() {
            // 先立即获取一次日志
            refreshLogs();

            // 每2秒轮询一次日志
            logPollingInterval = setInterval(refreshLogs, 2000);
        }

        function stopLogPolling() {
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
                logPollingInterval = null;
            }
        }

        async function refreshLogs() {
            try {
                const response = await fetch('/api/frpc-logs');
                const result = await response.json();

                if (result.success) {
                    updateLogOutput(result.logs);
                    updateLogStatus(result.isRunning);

                    // 如果进程已停止，停止轮询并恢复按钮状态
                    if (!result.isRunning) {
                        stopLogPolling();

                        // 恢复连接按钮状态
                        const connectBtn = document.querySelector('.connect-frps-btn');
                        connectBtn.disabled = false;
                        connectBtn.textContent = '连接至frps';
                        connectBtn.style.background = '';
                    }
                }
            } catch (error) {
                console.error('获取日志失败:', error);
            }
        }

        function updateLogOutput(logs) {
            const logOutput = document.getElementById('logOutput');

            if (!logs || logs.length === 0) {
                logOutput.textContent = '暂无日志输出...';
                return;
            }

            // 将日志数组转换为字符串
            const logText = logs.join('\n');
            logOutput.textContent = logText;

            // 滚动到底部显示最新日志
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        async function stopFrpc() {
            try {
                const response = await fetch('/api/stop-frpc', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    updateLogStatus(false);
                    stopLogPolling();

                    // 恢复连接按钮状态
                    const connectBtn = document.querySelector('.connect-frps-btn');
                    connectBtn.disabled = false;
                    connectBtn.textContent = '连接至frps';
                    connectBtn.style.background = '';

                    await showCustomAlert('FRP客户端已停止', 'success', '操作成功');
                } else {
                    await showCustomAlert(result.message || '停止失败', 'error', '操作失败');
                }
            } catch (error) {
                console.error('停止frpc失败:', error);
                await showCustomAlert('停止失败，请检查网络连接', 'error', '网络错误');
            }
        }
    </script>
</body>
</html>